{% extends "admin/base.html" %}

{% block title %}Manage Cars{% endblock %}
{% block page_title %}Manage Cars{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Total Cars</p>
                <p class="text-3xl font-bold text-gray-900">{{ cars|length }}</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i class="fas fa-car text-blue-600 text-2xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Available</p>
                <p class="text-3xl font-bold text-green-600">{{ cars|selectattr('available')|list|length }}</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
                <i class="fas fa-check-circle text-green-600 text-2xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Sports Cars</p>
                <p class="text-3xl font-bold text-purple-600">{{ cars|selectattr('category', 'equalto', 'Sports')|list|length }}</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <i class="fas fa-rocket text-purple-600 text-2xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Luxury Cars</p>
                <p class="text-3xl font-bold text-yellow-600">{{ cars|selectattr('category', 'equalto', 'Luxury')|list|length }}</p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
                <i class="fas fa-gem text-yellow-600 text-2xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Search and Actions Bar -->
<div class="bg-white rounded-lg shadow mb-6 p-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex-1">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search cars by name, brand, or category..." 
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
        <div class="flex gap-3">
            <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">All Categories</option>
                <option value="Sports">Sports</option>
                <option value="Luxury">Luxury</option>
                <option value="SUV">SUV</option>
                <option value="Electric">Electric</option>
                <option value="Sedan">Sedan</option>
            </select>
            <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">All Status</option>
                <option value="available">Available</option>
                <option value="unavailable">Unavailable</option>
            </select>
            <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 inline-flex items-center">
                <i class="fas fa-download mr-2"></i>
                Export
            </button>
            <a href="/admin/cars/add" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 inline-flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Add New Car
            </a>
        </div>
    </div>
</div>

<!-- Bulk Actions Bar (Hidden by default) -->
<div id="bulkActions" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6" style="display: none;">
    <div class="flex items-center justify-between">
        <span class="text-blue-800 font-semibold">
            <i class="fas fa-check-square mr-2"></i>
            <span id="selectedCount">0</span> cars selected
        </span>
        <div class="flex gap-3">
            <button onclick="bulkDelete()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                <i class="fas fa-trash mr-2"></i>Delete Selected
            </button>
            <button onclick="bulkChangeStatus(true)" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                <i class="fas fa-check mr-2"></i>Mark Available
            </button>
            <button onclick="bulkChangeStatus(false)" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                <i class="fas fa-times mr-2"></i>Mark Unavailable
            </button>
        </div>
    </div>
</div>

<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Car</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Brand</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price/Day</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Seats</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="carsTableBody">
                {% for car in cars %}
                <tr class="hover:bg-gray-50 car-row" data-index="{{ loop.index0 }}" style="display: {{ 'table-row' if loop.index0 < 8 else 'none' }}">
                    <td class="px-6 py-4 text-sm text-gray-900">{{ car.id }}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <img src="{{ car.image_url }}" alt="{{ car.name }}" class="w-16 h-16 object-cover rounded">
                            <span class="ml-3 text-sm font-medium text-gray-900">{{ car.name }}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ car.brand }}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ car.category }}</td>
                    <td class="px-6 py-4 text-sm font-semibold text-gray-900">{{ car.price_per_day|khr }}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ car.seats }}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold
                            {% if car.available %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {% if car.available %}Available{% else %}Unavailable{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                        <button onclick="quickView({{ car.id }})" class="text-purple-600 hover:text-purple-800 mr-3" title="Quick View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <a href="/admin/cars/edit/{{ car.id }}" class="text-blue-600 hover:text-blue-800 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button onclick="toggleAvailability({{ car.id }}, {{ 'true' if car.available else 'false' }})" 
                            class="text-yellow-600 hover:text-yellow-800 mr-3" title="Toggle Status">
                            <i class="fas fa-toggle-{{ 'on' if car.available else 'off' }}"></i>
                        </button>
                        <button onclick="deleteCar({{ car.id }})" class="text-red-600 hover:text-red-800" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Load More Button -->
<div class="mt-6 text-center" id="loadMoreContainer">
    <button id="loadMoreBtn" onclick="loadMoreCars()" class="bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700 transition inline-flex items-center shadow-md">
        <i class="fas fa-chevron-down mr-2"></i>
        Load More Cars
        <span id="loadMoreCount" class="ml-2 bg-purple-700 px-2 py-1 rounded-full text-xs"></span>
    </button>
</div>

<script>
// Delete Car Function
async function deleteCar(carId) {
    if (!confirm('Are you sure you want to delete this car?')) return;
    
    try {
        const response = await fetch(`/admin/cars/delete/${carId}`, {
            method: 'POST'
        });
        if (response.ok) {
            showNotification('Car deleted successfully', 'success');
            location.reload();
        } else {
            showNotification('Failed to delete car', 'error');
        }
    } catch (error) {
        showNotification('Error deleting car', 'error');
    }
}

// Toggle Car Availability
async function toggleAvailability(carId, currentStatus) {
    try {
        const response = await fetch(`/admin/cars/toggle/${carId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ available: !currentStatus })
        });
        if (response.ok) {
            showNotification('Status updated successfully', 'success');
            location.reload();
        }
    } catch (error) {
        showNotification('Error updating status', 'error');
    }
}

// Search and Filter Functionality
const searchInput = document.getElementById('searchInput');
const categoryFilter = document.getElementById('categoryFilter');
const statusFilter = document.getElementById('statusFilter');
const tableRows = document.querySelectorAll('tbody tr');

function filterTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value.toLowerCase();
    const selectedStatus = statusFilter.value.toLowerCase();
    
    let visibleCount = 0;
    
    tableRows.forEach(row => {
        const carName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const brand = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
        const category = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
        const status = row.querySelector('td:nth-child(7)').textContent.toLowerCase();
        
        const matchesSearch = carName.includes(searchTerm) || brand.includes(searchTerm) || category.includes(searchTerm);
        const matchesCategory = !selectedCategory || category.includes(selectedCategory);
        const matchesStatus = !selectedStatus || status.includes(selectedStatus);
        
        if (matchesSearch && matchesCategory && matchesStatus) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update result count
    updateResultCount(visibleCount);
}

function updateResultCount(count) {
    let countElement = document.getElementById('resultCount');
    if (!countElement) {
        countElement = document.createElement('div');
        countElement.id = 'resultCount';
        countElement.className = 'text-sm text-gray-600 mb-2 px-6 py-2';
        document.querySelector('.overflow-x-auto').parentElement.insertBefore(countElement, document.querySelector('.overflow-x-auto'));
    }
    countElement.textContent = `Showing ${count} of ${tableRows.length} cars`;
}

// Add event listeners
searchInput.addEventListener('input', filterTable);
categoryFilter.addEventListener('change', filterTable);
statusFilter.addEventListener('change', filterTable);

// Show Notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Export to CSV
function exportToCSV() {
    const rows = [['ID', 'Car Name', 'Brand', 'Category', 'Price/Day', 'Seats', 'Status']];
    
    tableRows.forEach(row => {
        if (row.style.display !== 'none') {
            const cols = row.querySelectorAll('td');
            rows.push([
                cols[0].textContent.trim(),
                cols[1].textContent.trim(),
                cols[2].textContent.trim(),
                cols[3].textContent.trim(),
                cols[4].textContent.trim(),
                cols[5].textContent.trim(),
                cols[6].textContent.trim()
            ]);
        }
    });
    
    const csvContent = rows.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cars_export_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

// Bulk Actions
let selectedCars = [];

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.car-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedCars.push(parseInt(cb.value));
        }
    });
    if (!checkbox.checked) selectedCars = [];
    updateBulkActions();
}

function toggleSelectCar(checkbox, carId) {
    if (checkbox.checked) {
        selectedCars.push(carId);
    } else {
        selectedCars = selectedCars.filter(id => id !== carId);
    }
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActionsDiv = document.getElementById('bulkActions');
    if (bulkActionsDiv) {
        bulkActionsDiv.style.display = selectedCars.length > 0 ? 'block' : 'none';
        document.getElementById('selectedCount').textContent = selectedCars.length;
    }
}

// Bulk Delete
async function bulkDelete() {
    if (!confirm(`Are you sure you want to delete ${selectedCars.length} cars?`)) return;
    
    try {
        for (const carId of selectedCars) {
            await fetch(`/admin/cars/delete/${carId}`, { method: 'POST' });
        }
        showNotification(`${selectedCars.length} cars deleted successfully`, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error deleting cars', 'error');
    }
}

// Bulk Change Status
async function bulkChangeStatus(available) {
    try {
        for (const carId of selectedCars) {
            await fetch(`/admin/cars/toggle/${carId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ available })
            });
        }
        showNotification(`${selectedCars.length} cars updated successfully`, 'success');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showNotification('Error updating cars', 'error');
    }
}

// Quick View Car Details
function quickView(carId) {
    // Create modal for quick view
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Car Details</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="quickViewContent">Loading...</div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Fetch car details
    fetch(`/admin/cars/view/${carId}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('quickViewContent').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>ID:</strong> ${data.id}</div>
                    <div><strong>Name:</strong> ${data.name}</div>
                    <div><strong>Brand:</strong> ${data.brand}</div>
                    <div><strong>Category:</strong> ${data.category}</div>
                    <div><strong>Price/Day:</strong> $${data.price}</div>
                    <div><strong>Seats:</strong> ${data.seats}</div>
                    <div><strong>Transmission:</strong> ${data.transmission}</div>
                    <div><strong>Status:</strong> ${data.available ? 'Available' : 'Unavailable'}</div>
                </div>
                <div class="mt-4">
                    <img src="${data.image}" alt="${data.name}" class="w-full h-64 object-cover rounded">
                </div>
            `;
        })
        .catch(() => {
            document.getElementById('quickViewContent').innerHTML = '<p class="text-red-600">Error loading details</p>';
        });
}

// Pagination - Load More Functionality
let currentlyShown = 8;
const ITEMS_PER_PAGE = 8;
const allRows = document.querySelectorAll('.car-row');
const loadMoreBtn = document.getElementById('loadMoreBtn');
const loadMoreCount = document.getElementById('loadMoreCount');

function loadMoreCars() {
    let loaded = 0;
    
    allRows.forEach((row, index) => {
        if (index >= currentlyShown && index < currentlyShown + ITEMS_PER_PAGE) {
            // Check if row matches current filters
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value.toLowerCase();
            const selectedStatus = statusFilter.value.toLowerCase();
            
            const carName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const brand = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const category = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
            const status = row.querySelector('td:nth-child(7)').textContent.toLowerCase();
            
            const matchesSearch = carName.includes(searchTerm) || brand.includes(searchTerm) || category.includes(searchTerm);
            const matchesCategory = !selectedCategory || category.includes(selectedCategory);
            const matchesStatus = !selectedStatus || status.includes(selectedStatus);
            
            if (matchesSearch && matchesCategory && matchesStatus) {
                row.style.display = 'table-row';
                loaded++;
            }
        }
    });
    
    currentlyShown += ITEMS_PER_PAGE;
    updateLoadMoreButton();
    
    // Smooth scroll animation
    if (loaded > 0) {
        showNotification(`Loaded ${loaded} more cars`, 'success');
    }
}

function updateLoadMoreButton() {
    let hiddenCount = 0;
    
    allRows.forEach((row, index) => {
        if (row.style.display === 'none' || index >= currentlyShown) {
            hiddenCount++;
        }
    });
    
    if (hiddenCount === 0) {
        loadMoreBtn.style.display = 'none';
    } else {
        loadMoreBtn.style.display = 'inline-flex';
        const remaining = Math.min(ITEMS_PER_PAGE, hiddenCount);
        loadMoreCount.textContent = `+${remaining}`;
    }
}

function resetPagination() {
    currentlyShown = 8;
    allRows.forEach((row, index) => {
        if (index < 8) {
            row.style.display = 'table-row';
        } else {
            row.style.display = 'none';
        }
    });
    updateLoadMoreButton();
}

// Update filter function to work with pagination
const originalFilterTable = filterTable;
filterTable = function() {
    // Reset pagination when filtering
    currentlyShown = 8;
    
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value.toLowerCase();
    const selectedStatus = statusFilter.value.toLowerCase();
    
    let visibleCount = 0;
    
    allRows.forEach((row, index) => {
        const carName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const brand = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
        const category = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
        const status = row.querySelector('td:nth-child(7)').textContent.toLowerCase();
        
        const matchesSearch = carName.includes(searchTerm) || brand.includes(searchTerm) || category.includes(searchTerm);
        const matchesCategory = !selectedCategory || category.includes(selectedCategory);
        const matchesStatus = !selectedStatus || status.includes(selectedStatus);
        
        if (matchesSearch && matchesCategory && matchesStatus) {
            // Show only first 8 matching items
            if (visibleCount < 8) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
            }
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    updateResultCount(visibleCount);
    updateLoadMoreButton();
};

// Initialize
updateResultCount(tableRows.length);
updateLoadMoreButton();
</script>
{% endblock %}
